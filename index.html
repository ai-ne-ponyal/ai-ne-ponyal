<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI ne ponyal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f0f0f;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }

    .box { max-width: 420px; padding: 24px; width: 100%; }
    h1 { font-size: 36px; margin: 0 0 12px; }

    p {
      font-size: 16px;
      opacity: 0.8;
      line-height: 1.5;
      white-space: pre-line;
      margin: 0;
    }

    .small { font-size: 13px; opacity: 0.5; margin-top: 24px; }

    a { color: #ffffff; text-decoration: underline; opacity: 0.85; }
    a:hover { opacity: 1; }

    .actions {
      margin-top: 28px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .btn {
      display: inline-block;
      padding: 14px 18px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      text-decoration: none;
      border: 0;
      cursor: pointer;
      transition: transform 0.15s ease, opacity 0.15s ease;
      user-select: none;
    }
    .btn:hover { transform: translateY(-1px); opacity: 0.95; }
    .btn:active { transform: translateY(0); }
    .btn:disabled { cursor: not-allowed; opacity: 0.65; transform: none; }

    .btn-tiktok {
      background: linear-gradient(135deg, #25f4ee, #fe2c55);
      color: #0f0f0f;
      text-decoration: none;
    }

    .btn-generate {
      background: #1f1f1f;
      border: 1px solid #2a2a2a;
      color: #ffffff;
    }

    .error-box {
      margin-top: 6px;
      padding: 14px 16px;
      border-radius: 12px;
      background: rgba(254, 44, 85, 0.08);
      border: 1px solid rgba(254, 44, 85, 0.6);
      text-align: left;
      display: none;
    }
    .error-box strong { display: block; margin-bottom: 6px; font-size: 14px; }

    /* === Compact RESULT shown on page === */
    .result {
      margin-top: 6px;
      padding: 14px 16px;
      border-radius: 12px;
      background: #151515;
      border: 1px solid #2a2a2a;
      text-align: center;
      display: none;
    }

    .result strong {
      display: block;
      margin-bottom: 10px;
      font-size: 16px;
      letter-spacing: -0.2px;
    }

    .cta {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #2a2a2a;
      opacity: 0.92;
      text-align: center;
    }

    .pill {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 999px;
      background: #1f1f1f;
      border: 1px solid #2a2a2a;
      font-weight: 800;
      letter-spacing: 0.2px;
      text-decoration: none;
      font-size: 16px;
    }

    .open-link {
      text-decoration: none;
      opacity: 0.9;
      font-weight: 700;
      color: #69c9d0;
    }
    .open-link:hover { opacity: 1; text-decoration: underline; }

    .meta-row {
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* === NEW: nicer buttons + inline SVG icons === */
    .share-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;

      padding: 10px;
      border-radius: 14px;

      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(6px);

      color: #ffffff;
      font-size: 14px;
      font-weight: 800;

      cursor: pointer;
      transition: transform 0.15s ease, background 0.15s ease, opacity 0.15s ease;
      white-space: nowrap;
    }
    .share-btn:hover { transform: translateY(-1px); background: rgba(255,255,255,0.10); }
    .share-btn:active { transform: translateY(0); }
    .share-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .share-btn .icon {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 18px;
    }

    .share-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
      opacity: 0.9;
    }

    #shareHint {
      margin-top: 10px;
      font-size: 13px;
      opacity: 0.6;
      display: none;
      text-align: left;
    }

    .tiktok {
      margin-top: 28px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      font-size: 15px;
      color: #ffffff;
      opacity: 0.9;
    }
    .tiktok svg { width: 20px; height: 20px; fill: white; opacity: 0.9; }
    .tiktok:hover { opacity: 1; text-decoration: underline; }

    /* === Hidden PNG render area === */
    .png-stage {
      position: fixed;
      left: -99999px;
      top: 0;
      width: 1080px;
      height: 1080px;
      pointer-events: none;
      opacity: 0;
    }

    .png-card {
      width: 1080px;
      height: 1080px;
      background:
        radial-gradient(1200px 650px at 30% -10%, rgba(255,255,255,0.09), transparent 55%),
        radial-gradient(900px 500px at 110% 10%, rgba(105,201,208,0.10), transparent 60%),
        #0f0f0f;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 84px;
      box-sizing: border-box;
    }

    .png-inner {
      width: 100%;
      border-radius: 40px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 30px 90px rgba(0,0,0,0.55);
      padding: 64px;
      box-sizing: border-box;
      text-align: center;
    }

    .png-title {
      font-size: 60px;
      line-height: 1.05;
      font-weight: 900;
      letter-spacing: -1.2px;
      margin: 0 0 28px;
    }

    .png-desc {
      font-size: 34px;
      line-height: 1.45;
      opacity: 0.88;
      margin: 0 0 44px;
      white-space: pre-line;
    }

    .png-sep {
      height: 2px;
      background: rgba(255,255,255,0.10);
      margin: 0 0 40px;
      border-radius: 2px;
    }

    .png-cta {
      font-size: 44px;
      font-weight: 900;
      line-height: 1.15;
      margin: 0 0 26px;
    }

    .png-pill {
      display: inline-block;
      font-size: 42px;
      font-weight: 900;
      padding: 22px 30px;
      border-radius: 999px;
      background: rgba(0,0,0,0.22);
      border: 2px solid rgba(255,255,255,0.10);
      letter-spacing: 0.4px;
      margin-bottom: 34px;
    }

    .png-account {
      font-size: 34px;
      opacity: 0.9;
      margin: 0;
    }

    .png-handle {
      color: #69c9d0;
      font-weight: 900;
    }

    .png-brand {
      margin-top: 30px;
      font-size: 26px;
      opacity: 0.65;
      letter-spacing: 0.6px;
      font-weight: 800;
    }
  </style>
</head>

<body>
  <div class="box">
    <h1>AI –Ω–µ –ø–æ–Ω—è–ª</h1>

    <p>When AI tries its best.<br />Sometimes it doesn't.</p>
    <p style="margin-top:12px;">Personal experimental project.<br />No data collection. No tracking.</p>

    <div class="actions">
      <button id="tiktokAuthBtn" class="btn btn-tiktok" type="button">
        Sign in with TikTok (admin only)
      </button>

      <button id="genBtn" class="btn btn-generate" type="button">
        Queue post
      </button>

      <div id="limitsInfo" class="limits-info" style="margin-top: 16px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; font-size: 14px; text-align: center; opacity: 0.8;">
        <span id="limitsText">Loading limits...</span>
      </div>

      <div id="errorBox" class="error-box" aria-live="polite">
        <strong id="errorTitle">‚ö†Ô∏è Error</strong>
        <div id="errorText">Something went wrong.</div>
      </div>

      <!-- Compact UI card (shown to user) -->
      <div id="result" class="result" aria-live="polite">
        <strong id="uiHeader">üß† AI –≥–æ—Ç–æ–≤–∏—Ç —á—Ç–æ-—Ç–æ —Å–º–µ—à–Ω–æ–µ</strong>
        <p id="uiDescription"></p>

        <div class="cta">
          <div style="font-weight:900; font-size:18px; opacity:0.95;">
            –ò—â–∏ —à—É—Ç–∫—É –ø–æ–∑–∂–µ –≤ TikTok –ø–æ —Ö—ç—à—Ç–µ–≥—É
          </div>

          <div style="margin-top:10px;">
            <a id="uiHashtagLink" class="pill" href="#" target="_blank" rel="noopener noreferrer">#‚Äî</a>
          </div>

          <div style="margin-top:12px; opacity:0.92;">
            –ò–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞:
            <a class="open-link" href="https://www.tiktok.com/@ai_ne_ponyal" target="_blank" rel="noopener noreferrer">
              @ai_ne_ponyal
            </a>
          </div>
        </div>

         <div class="meta-row">
           <button id="shareNativeBtn" class="share-btn" type="button" disabled style="display:none;" aria-label="Share">
             <span class="icon" aria-hidden="true">
               <svg viewBox="0 0 24 24"><path d="M18 8a3 3 0 1 0-2.83-4H15a3 3 0 0 0 .17 1L7.91 9.7a3 3 0 1 0 0 4.6l7.26 4.7A3 3 0 1 0 16 18a3 3 0 0 0-.17 1L8.57 14.3A3 3 0 1 0 6 12a3 3 0 0 0 .17 1l7.26-4.7A3 3 0 0 0 18 8Z"/></svg>
             </span>
           </button>

           <button id="copyImageBtn" class="share-btn" type="button" disabled style="display:none;" aria-label="Copy card">
             <span class="icon" aria-hidden="true">
               <svg viewBox="0 0 24 24"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H8V7h11v14Z"/></svg>
             </span>
           </button>

           <button id="downloadPngBtn" class="share-btn" type="button" disabled style="display:none;" aria-label="Download PNG">
             <span class="icon" aria-hidden="true">
               <svg viewBox="0 0 24 24"><path d="M12 3v10.17l3.59-3.58L17 11l-5 5-5-5 1.41-1.41L11 13.17V3h1Zm-7 16h14v2H5v-2Z"/></svg>
             </span>
           </button>
         </div>

        <div id="shareHint">Tip: for Telegram, ‚ÄúCopy card‚Äù ‚Üí paste into chat works best.</div>
      </div>
    </div>

    <a class="tiktok" href="https://www.tiktok.com/@ai_ne_ponyal" target="_blank" rel="noopener noreferrer">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M21 8.3c-1.5 0-3-.5-4.2-1.4v7.2a6.1 6.1 0 1 1-6.1-6.1c.3 0 .6 0 .9.1v3.1a2.9 2.9 0 1 0 2 2.8V2h3.2c.3 2.1 2 3.8 4.2 4.1v2.2z"/>
      </svg>
      Follow on TikTok @ai_ne_ponyal
    </a>

    <div class="small">
      <a href="./privacy.html">Privacy Policy</a> ¬∑
      <a href="./terms.html">Terms of Service</a> ¬∑
      <a href="./intentions.html">Your Queues</a>
    </div>
  </div>

  <!-- Hidden PNG render stage -->
  <div class="png-stage" aria-hidden="true">
    <div id="pngCard" class="png-card">
      <div class="png-inner">
        <div id="pngHeader" class="png-title">üß† AI –≥–æ—Ç–æ–≤–∏—Ç —á—Ç–æ-—Ç–æ —Å–º–µ—à–Ω–æ–µ</div>
        <div id="pngDescription" class="png-desc"></div>

        <div class="png-sep"></div>

        <div class="png-cta">–ò—â–∏ —à—É—Ç–∫—É –ø–æ–∑–∂–µ –≤ TikTok –ø–æ —Ö—ç—à—Ç–µ–≥—É</div>
        <div id="pngHashtag" class="png-pill">#‚Äî</div>

        <p class="png-account">
          –ò–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞: <span class="png-handle">@ai_ne_ponyal</span>
        </p>

        <div class="png-brand">#aiNePonyal</div>
      </div>
    </div>
  </div>

  <!-- html-to-image -->
  <script defer src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>

  <script>
    const API_BASE = "https://70ec38ff6d36.ngrok-free.app";

    const btn = document.getElementById("genBtn");
    const tiktokAuthBtn = document.getElementById("tiktokAuthBtn");

    const errorBox = document.getElementById("errorBox");
    const errorTitle = document.getElementById("errorTitle");
    const errorText = document.getElementById("errorText");

    const resultContainer = document.getElementById("result");

    // UI fields
    const uiHeader = document.getElementById("uiHeader");
    const uiDescription = document.getElementById("uiDescription");
    const uiHashtagLink = document.getElementById("uiHashtagLink");

    // PNG fields
    const pngCard = document.getElementById("pngCard");
    const pngHeader = document.getElementById("pngHeader");
    const pngDescription = document.getElementById("pngDescription");
    const pngHashtag = document.getElementById("pngHashtag");

    // Share buttons
    const shareNativeBtn = document.getElementById("shareNativeBtn");
    const copyImageBtn = document.getElementById("copyImageBtn");
    const downloadPngBtn = document.getElementById("downloadPngBtn");
    const shareHint = document.getElementById("shareHint");

    let lastResult = null;

    const SHARE_TEXTS = [
      (tags, url) => `AI –Ω–µ –ø–æ–Ω—è–ª, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–∑—è–ª—Å—è –∑–∞ —Ä–∞–±–æ—Ç—É üò§\n${tags}\n${url}`,
      (tags, url) => `AI –ø–æ—Ç—è–Ω—É–ª—Å—è, –≤–¥–æ—Ö–Ω—É–ª‚Ä¶ –∏ –ø–æ—à—ë–ª –¥—É–º–∞—Ç—å üß†\n${tags}\n${url}`,
      (tags, url) => `AI –¥–µ–ª–∞–µ—Ç –≤–∏–¥, —á—Ç–æ –≤—Å—ë –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º üòé\n${tags}\n${url}`,
      (tags, url) => `AI –≥–æ—Ç–æ–≤–∏—Ç —à—É—Ç–∫—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –ø—É–≥–∞–π—Ç–µ –µ–≥–æ üòÖ\n${tags}\n${url}`,
      (tags, url) => `AI —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ. –®—É—Ç–∫–∞ –±—É–¥–µ—Ç! (–Ω–∞–≤–µ—Ä–Ω–æ–µ) ü§ù\n${tags}\n${url}`,
      (tags, url) => `AI —Ä–∞–∑–º–∏–Ω–∞–µ—Ç –∫–æ–ª–µ–Ω–∏ –∏ –º–æ–∑–≥–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ üß¥üß†\n${tags}\n${url}`,
    ];

    function showError(title, text) {
      resultContainer.style.display = "none";
      errorBox.style.display = "block";
      errorTitle.textContent = title;
      errorText.textContent = text;
      disableShareButtons();
    }

    function hideError() {
      errorBox.style.display = "none";
    }

    function disableShareButtons() {
      [shareNativeBtn, copyImageBtn, downloadPngBtn].forEach(b => b.disabled = true);
    }

    function setShareButtonsEnabled(enabled) {
      [shareNativeBtn, copyImageBtn, downloadPngBtn].forEach(b => {
        if (b.style.display !== "none") b.disabled = !enabled;
      });
    }

    function tiktokSearchUrlByHashtag(tagWithoutHash) {
      return `https://www.tiktok.com/search?q=%23aineponyal%20%23${encodeURIComponent(tagWithoutHash)}`;
    }

    function detectShareCapabilities() {
      const canNativeShare = !!(navigator.share && navigator.canShare);
      const canCopyImage = !!(navigator.clipboard && window.ClipboardItem);
      const canDownload = true;

      shareNativeBtn.style.display = canNativeShare ? "" : "none";
      copyImageBtn.style.display = canCopyImage ? "" : "none";
      downloadPngBtn.style.display = canDownload ? "" : "none";

      shareHint.style.display = (copyImageBtn.style.display !== "none") ? "" : "none";
    }

    detectShareCapabilities();

    function buildShareTitle(jokeId) {
      return `AI –Ω–µ –ø–æ–Ω—è–ª ¬∑ ${jokeId}`;
    }

    function buildShareText(jokeId) {
      const tags = `#aiNePonyal #${jokeId}`;
      const url = tiktokSearchUrlByHashtag(jokeId);
      const pick = SHARE_TEXTS[Math.floor(Math.random() * SHARE_TEXTS.length)];
      return pick(tags, url);
    }

     function setBusy(btnEl, busyText) {
       btnEl.disabled = true;
       return () => {
         btnEl.disabled = (resultContainer.style.display === "none");
       };
     }

    function fillCards(data) {
      const id = String(data.joke_id);
      const hashtag = `#${id}`;
      const searchUrl = tiktokSearchUrlByHashtag(id);

      // UI compact card
      uiHeader.textContent = data.header || "üß† AI –≥–æ—Ç–æ–≤–∏—Ç —á—Ç–æ-—Ç–æ —Å–º–µ—à–Ω–æ–µ";
      uiDescription.textContent = data.description || "–ù—É–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. AI —É–∂–µ –≥–æ—Ç–æ–≤–∏—Ç—Å—è –¥—É–º–∞—Ç—å.";
      uiHashtagLink.textContent = hashtag;
      uiHashtagLink.href = searchUrl;

      // PNG card (hidden)
      pngHeader.textContent = data.header || "üß† AI –≥–æ—Ç–æ–≤–∏—Ç —á—Ç–æ-—Ç–æ —Å–º–µ—à–Ω–æ–µ";
      pngDescription.textContent = data.description || "–ù—É–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. AI —É–∂–µ –≥–æ—Ç–æ–≤–∏—Ç—Å—è –¥—É–º–∞—Ç—å.";
      pngHashtag.textContent = hashtag;

      lastResult = { ...data, _searchUrl: searchUrl };
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    async function ensureHtmlToImageLoaded() {
      if (window.htmlToImage && typeof window.htmlToImage.toPng === "function") return;

      const candidates = [
        "https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.min.js",
        "https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js",
      ];

      for (const url of candidates) {
        try {
          await loadScript(url);
          if (window.htmlToImage && typeof window.htmlToImage.toPng === "function") return;
        } catch {}
      }

      throw new Error("html-to-image not available");
    }

    async function renderPngCardToDataUrl() {
      await ensureHtmlToImageLoaded();
      return await window.htmlToImage.toPng(pngCard, {
        pixelRatio: 1,
        cacheBust: true,
        backgroundColor: "#0f0f0f",
      });
    }

    function dataUrlToFile(dataUrl, filename) {
      const arr = dataUrl.split(",");
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) u8arr[n] = bstr.charCodeAt(n);
      return new File([u8arr], filename, { type: mime });
    }

    async function copyImageToClipboard(dataUrl) {
      const blob = await (await fetch(dataUrl)).blob();
      await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
    }

    function downloadDataUrl(dataUrl, filename) {
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function nativeSharePngFile(file, jokeId) {
      const title = buildShareTitle(jokeId);
      const text = buildShareText(jokeId);
      await navigator.share({ title, text, files: [file] });
    }

    shareNativeBtn.addEventListener("click", async () => {
      if (!lastResult) return;

      const restore = setBusy(shareNativeBtn, "Sharing‚Ä¶");
      try {
        const dataUrl = await renderPngCardToDataUrl();
        const filename = `ai-ne-ponyal-${lastResult.joke_id}.png`;
        const file = dataUrlToFile(dataUrl, filename);

        if (!navigator.canShare || !navigator.canShare({ files: [file] })) {
          if (copyImageBtn.style.display !== "none") {
            await copyImageToClipboard(dataUrl);
          } else {
            downloadDataUrl(dataUrl, filename);
          }
          setTimeout(restore, 1000);
          return;
        }

        await nativeSharePngFile(file, lastResult.joke_id);
        setTimeout(restore, 1000);
      } catch (e) {
        console.error(e);

        const name = (e && (e.name || e.constructor?.name)) || "";
        const msg = (e && e.message) || "";
        const isAbort =
          name === "AbortError" ||
          name === "NotAllowedError" ||
          /abort|cancell?ed|dismiss/i.test(msg);

        if (isAbort) {
          restore();
          return;
        }

        restore();
        showError("ü§ñ AI –æ—Ç–≤–ª—ë–∫—Å—è", "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–∞—Ä—Ç–æ—á–∫–æ–π. –ü–æ–ø—Ä–æ–±—É–π ‚ÄúCopy card‚Äù –∏–ª–∏ ‚ÄúDownload PNG‚Äù.");
      }
    });

    copyImageBtn.addEventListener("click", async () => {
      if (!lastResult) return;

      const restore = setBusy(copyImageBtn, "Copying‚Ä¶");
      try {
        const dataUrl = await renderPngCardToDataUrl();
        await copyImageToClipboard(dataUrl);
        setTimeout(restore, 1000);
      } catch (e) {
        console.error(e);
        restore();
        showError("ü§ñ AI –æ—Ç–≤–ª—ë–∫—Å—è", "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É. –ü–æ–ø—Ä–æ–±—É–π ‚ÄúDownload PNG‚Äù.");
      }
    });

    downloadPngBtn.addEventListener("click", async () => {
      if (!lastResult) return;

      const restore = setBusy(downloadPngBtn, "Preparing‚Ä¶");
      try {
        const dataUrl = await renderPngCardToDataUrl();
        const filename = `ai-ne-ponyal-${lastResult.joke_id}.png`;
        downloadDataUrl(dataUrl, filename);
        setTimeout(restore, 1000);
      } catch (e) {
        console.error(e);
        restore();
        showError("ü§ñ AI –æ—Ç–≤–ª—ë–∫—Å—è", "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
      }
    });

    btn.addEventListener("click", async () => {
      btn.disabled = true;
      btn.textContent = "AI is thinking‚Ä¶";
      disableShareButtons();

      try {
        const res = await fetch(`${API_BASE}/post/create`, {
          method: "GET",
          headers: { "Accept": "application/json", "ngrok-skip-browser-warning": "true" },
        });

        if (!res.ok) {
          showError("ü§ñ AI –Ω—É–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏", "–°–µ–π—á–∞—Å –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –Ω–∞—á–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
          return;
        }

        const data = await res.json();

        if (!data || !data.joke_id) {
          showError("ü§ñ AI –∑–∞–±—ã–ª –Ω–æ–º–µ—Ä —à—É—Ç–∫–∏", "–í –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ—Ç joke_id.");
          return;
        }

        hideError();
        resultContainer.style.display = "block";

        fillCards(data);
        setShareButtonsEnabled(true);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–º–∏—Ç—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
        loadLimits();
      } catch (e) {
        console.error(e);
        showError("ü§ñ AI –Ω–µ –¥–æ–±—Ä–∞–ª—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞", "–°–µ—Ä–≤–µ—Ä —Å–µ–π—á–∞—Å –æ—Ç–¥—ã—Ö–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
      } finally {
        btn.disabled = false;
        btn.textContent = "Queue post";
      }
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏–º–∏—Ç–∞—Ö
    async function loadLimits() {
      try {
        const res = await fetch(`${API_BASE}/limits`, {
          method: "GET",
          headers: { "Accept": "application/json", "ngrok-skip-browser-warning": "true" },
        });
        if (res.ok) {
          const data = await res.json();
          const limitsText = document.getElementById("limitsText");
          if (limitsText && data.creation) {
            const remaining = data.creation.remaining;
            const max = data.creation.max;
            const used = data.creation.used;
            if (remaining > 0) {
              limitsText.textContent = `You can queue ${remaining} more post${remaining !== 1 ? 's' : ''} today (${used}/${max} used)`;
            } else {
              limitsText.textContent = `Daily limit reached (${used}/${max}). Try again tomorrow.`;
              limitsText.style.opacity = "0.6";
            }
          }
        }
      } catch (e) {
        console.error("Failed to load limits:", e);
      }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∏–º–∏—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadLimits();
    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–º–∏—Ç—ã –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadLimits, 30000);

    tiktokAuthBtn.addEventListener("click", async () => {
      tiktokAuthBtn.disabled = true;
      tiktokAuthBtn.textContent = "Checking...";

      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API –ø–µ—Ä–µ–¥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º
        const checkRes = await fetch(`${API_BASE}/intentions?page=1&page_size=1`, {
          method: "GET",
          headers: { "Accept": "application/json", "ngrok-skip-browser-warning": "true" },
          signal: AbortSignal.timeout(5000) // 5 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
        });

        // –ï—Å–ª–∏ API –¥–æ—Å—Ç—É–ø–µ–Ω, –¥–µ–ª–∞–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç
        window.location.href = `${API_BASE}/auth/start`;
      } catch (e) {
        console.error(e);
        showError("ü§ñ –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", "–°–Ω–æ–≤–∞ —É—à–µ–ª –æ—Ç–¥—ã—Ö–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        tiktokAuthBtn.disabled = false;
        tiktokAuthBtn.textContent = "Sign in with TikTok";
      }
    });
  </script>
</body>
</html>

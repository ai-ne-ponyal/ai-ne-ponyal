<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI ne ponyal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f0f0f;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }

    .box { max-width: 420px; padding: 24px; }

    h1 { font-size: 36px; margin-bottom: 12px; }

    p {
      font-size: 16px;
      opacity: 0.8;
      line-height: 1.5;
      white-space: pre-line; /* preserves \n from backend */
      margin: 0;
    }

    .small { font-size: 13px; opacity: 0.5; margin-top: 24px; }

    a { color: #ffffff; text-decoration: underline; opacity: 0.85; }
    a:hover { opacity: 1; }

    /* Action buttons */
    .actions {
      margin-top: 28px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .btn {
      display: inline-block;
      padding: 14px 18px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      text-decoration: none;
      border: 0;
      cursor: pointer;
      transition: transform 0.15s ease, opacity 0.15s ease;
      user-select: none;
    }

    .btn:hover { transform: translateY(-1px); opacity: 0.95; }
    .btn:active { transform: translateY(0); }
    .btn:disabled { cursor: not-allowed; opacity: 0.65; transform: none; }

    .btn-tiktok {
      background: linear-gradient(135deg, #25f4ee, #fe2c55);
      color: #0f0f0f;
      text-decoration: none;
    }

    .btn-generate {
      background: #1f1f1f;
      border: 1px solid #2a2a2a;
      color: #ffffff;
    }

    /* Result box */
    .result {
      margin-top: 6px;
      padding: 14px 16px;
      border-radius: 12px;
      background: #151515;
      border: 1px solid #2a2a2a;
      text-align: left;
      display: none;
    }

    .result strong {
      display: block;
      margin-bottom: 10px;
      font-size: 15px;
    }

    .cta {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #2a2a2a;
      opacity: 0.92;
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #1f1f1f;
      border: 1px solid #2a2a2a;
      font-weight: 700;
      letter-spacing: 0.2px;
      text-decoration: none;
    }

    .meta-row {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .open-link {
      text-decoration: none;
      opacity: 0.9;
      font-weight: 600;
      color: #69c9d0;
    }
    .open-link:hover { opacity: 1; text-decoration: underline; }

    .share-btn {
      background: #1f1f1f;
      border: 1px solid #2a2a2a;
      color: #ffffff;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s ease, opacity 0.15s ease;
      white-space: nowrap;
    }
    .share-btn:hover { transform: translateY(-1px); opacity: 0.95; }
    .share-btn:active { transform: translateY(0); }
    .share-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* Error box */
    .error-box {
      margin-top: 6px;
      padding: 14px 16px;
      border-radius: 12px;
      background: rgba(254, 44, 85, 0.08);
      border: 1px solid rgba(254, 44, 85, 0.6);
      text-align: left;
      display: none;
    }
    .error-box strong { display: block; margin-bottom: 6px; font-size: 14px; }

    /* TikTok link */
    .tiktok {
      margin-top: 28px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      font-size: 15px;
      color: #ffffff;
      opacity: 0.9;
    }
    .tiktok svg { width: 20px; height: 20px; fill: white; opacity: 0.9; }
    .tiktok:hover { opacity: 1; text-decoration: underline; }
  </style>
</head>

<body>
  <div class="box">
    <h1>AI –Ω–µ –ø–æ–Ω—è–ª</h1>

    <p>When AI tries its best.<br />Sometimes it doesn't.</p>

    <p style="margin-top:12px;">Personal experimental project.<br />No data collection. No tracking.</p>

    <div class="actions">
      <a class="btn btn-tiktok" href="https://70ec38ff6d36.ngrok-free.app/auth/start">
        Sign in with TikTok
      </a>

      <button id="genBtn" class="btn btn-generate" type="button">
        Generate post
      </button>

      <div id="errorBox" class="error-box" aria-live="polite">
        <strong id="errorTitle">‚ö†Ô∏è Error</strong>
        <div id="errorText">Something went wrong.</div>
      </div>

      <!-- Shareable card -->
      <div id="result" class="result" aria-live="polite">
        <strong id="resultHeader">ü§ñ AI is thinking‚Ä¶</strong>

        <!-- Story from backend -->
        <p id="resultDescription"></p>

        <!-- CTA in HTML -->
        <div class="cta">
          <div style="font-weight:700; font-size:18px; opacity:0.95;">
            –ò—â–∏ –µ—ë –ø–æ–∑–∂–µ –≤ TikTok –ø–æ —Ö—ç—à—Ç–µ–≥—É
          </div>

          <div style="margin-top:10px;">
            <a id="hashtagLink" class="pill" href="#" target="_blank" rel="noopener noreferrer">#‚Äî</a>
          </div>

          <div style="margin-top:12px; opacity:0.92;">
            –ò–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞:
            <a class="open-link" href="https://www.tiktok.com/@ai_ne_ponyal" target="_blank" rel="noopener noreferrer">
              @ai_ne_ponyal
            </a>
          </div>

          <div class="meta-row">
            <a id="tiktokSearchLink" class="open-link" href="#" target="_blank" rel="noopener noreferrer">
              üîç –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫ TikTok
            </a>

            <button id="shareCardBtn" class="share-btn" type="button">
              üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–∞—Ä—Ç–æ—á–∫–æ–π
            </button>
          </div>
        </div>
      </div>
    </div>

    <a class="tiktok" href="https://www.tiktok.com/@ai_ne_ponyal" target="_blank" rel="noopener noreferrer">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M21 8.3c-1.5 0-3-.5-4.2-1.4v7.2a6.1 6.1 0 1 1-6.1-6.1c.3 0 .6 0 .9.1v3.1a2.9 2.9 0 1 0 2 2.8V2h3.2c.3 2.1 2 3.8 4.2 4.1v2.2z"/>
      </svg>
      Follow on TikTok @ai_ne_ponyal
    </a>

    <div class="small">
      <a href="./privacy.html">Privacy Policy</a> ¬∑
      <a href="./terms.html">Terms of Service</a>
    </div>
  </div>

  <!-- Library for DOM -> PNG -->
  <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.min.js"></script>

  <script>
    const API_BASE = "https://70ec38ff6d36.ngrok-free.app";

    const btn = document.getElementById("genBtn");

    const errorBox = document.getElementById("errorBox");
    const errorTitle = document.getElementById("errorTitle");
    const errorText = document.getElementById("errorText");

    const resultCard = document.getElementById("result");
    const resultHeader = document.getElementById("resultHeader");
    const resultDescription = document.getElementById("resultDescription");

    const hashtagLink = document.getElementById("hashtagLink");
    const tiktokSearchLink = document.getElementById("tiktokSearchLink");

    const shareCardBtn = document.getElementById("shareCardBtn");
    shareCardBtn.disabled = true;

    let lastResult = null;

    function showError(title, text) {
      resultCard.style.display = "none";
      errorBox.style.display = "block";
      errorTitle.textContent = title;
      errorText.textContent = text;
      shareCardBtn.disabled = true;
    }

    function hideError() {
      errorBox.style.display = "none";
    }

    function tiktokSearchUrlByHashtag(tagWithoutHash) {
      return `https://www.tiktok.com/search?q=%23${encodeURIComponent(tagWithoutHash)}`;
    }

    function showResult(data) {
      hideError();
      resultCard.style.display = "block";

      const id = String(data.joke_id);
      const hashtag = `#${id}`;
      const searchUrl = tiktokSearchUrlByHashtag(id);

      resultHeader.textContent = data.header || "üß† AI –≥–æ—Ç–æ–≤–∏—Ç —á—Ç–æ-—Ç–æ —Å–º–µ—à–Ω–æ–µ";
      resultDescription.textContent = data.description || "–ù—É–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. AI —É–∂–µ –≥–æ—Ç–æ–≤–∏—Ç—Å—è –¥—É–º–∞—Ç—å.";

      hashtagLink.textContent = hashtag;
      hashtagLink.href = searchUrl;
      tiktokSearchLink.href = searchUrl;

      lastResult = { ...data, _searchUrl: searchUrl };
      shareCardBtn.disabled = false;
    }

    function dataUrlToFile(dataUrl, filename) {
      const arr = dataUrl.split(",");
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) u8arr[n] = bstr.charCodeAt(n);
      return new File([u8arr], filename, { type: mime });
    }

    async function shareCardAsImage() {
      // Render ONLY the card (#result) to PNG
      const dataUrl = await window.htmlToImage.toPng(resultCard, {
        pixelRatio: 2,
        cacheBust: true,
        backgroundColor: "#151515", // keep card background consistent
      });

      const file = dataUrlToFile(dataUrl, "ai-ne-ponyal.png");

      // 1) Best: native share with file (mostly mobile)
      if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
        await navigator.share({
          title: "AI –Ω–µ –ø–æ–Ω—è–ª",
          files: [file],
        });
        return { mode: "share" };
      }

      // 2) Copy image to clipboard (works in some browsers)
      if (navigator.clipboard && window.ClipboardItem) {
        const blob = await (await fetch(dataUrl)).blob();
        await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
        return { mode: "copy" };
      }

      // 3) Fallback: download
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = "ai-ne-ponyal.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      return { mode: "download" };
    }

    shareCardBtn.addEventListener("click", async () => {
      if (!lastResult) return;

      const oldText = shareCardBtn.textContent;
      shareCardBtn.disabled = true;
      shareCardBtn.textContent = "–ì–æ—Ç–æ–≤–ª—é –∫–∞—Ä—Ç–æ—á–∫—É‚Ä¶";

      try {
        const { mode } = await shareCardAsImage();

        // Small UX feedback without alerts
        if (mode === "copy") {
          shareCardBtn.textContent = "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
        } else if (mode === "download") {
          shareCardBtn.textContent = "‚¨áÔ∏è –°–∫–∞—á–∞–Ω–æ";
        } else {
          shareCardBtn.textContent = "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ";
        }

        setTimeout(() => {
          shareCardBtn.textContent = oldText;
          shareCardBtn.disabled = false;
        }, 1100);
      } catch (e) {
        console.error(e);
        shareCardBtn.textContent = oldText;
        shareCardBtn.disabled = false;
        showError("ü§ñ AI –æ—Ç–≤–ª—ë–∫—Å—è", "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–∞—Ä—Ç–æ—á–∫–æ–π. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
      }
    });

    btn.addEventListener("click", async () => {
      btn.disabled = true;
      btn.textContent = "AI is thinking‚Ä¶";

      try {
        const res = await fetch(`${API_BASE}/post/create`, {
          method: "GET",
          headers: {
            "Accept": "application/json",
            "ngrok-skip-browser-warning": "true"
          },
        });

        if (!res.ok) {
          showError("ü§ñ AI –Ω—É–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏", "–°–µ–π—á–∞—Å –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –Ω–∞—á–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
          return;
        }

        let data;
        try {
          data = await res.json();
        } catch {
          showError("ü§ñ AI –∑–∞–¥—É–º–∞–ª—Å—è —Å–ª–∏—à–∫–æ–º –≥–ª—É–±–æ–∫–æ", "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
          return;
        }

        if (!data || !data.joke_id) {
          showError("ü§ñ AI –∑–∞–±—ã–ª –Ω–æ–º–µ—Ä —à—É—Ç–∫–∏", "–í –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ—Ç joke_id.");
          return;
        }

        showResult(data);
      } catch (e) {
        console.error(e);
        showError("ü§ñ AI –Ω–µ –¥–æ–±—Ä–∞–ª—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
      } finally {
        btn.disabled = false;
        btn.textContent = "Generate post";
      }
    });
  </script>
</body>
</html>

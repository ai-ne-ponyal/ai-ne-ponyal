<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI ne ponyal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f0f0f;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }

    .box { max-width: 420px; padding: 24px; }
    h1 { font-size: 36px; margin-bottom: 12px; }

    p {
      font-size: 16px;
      opacity: 0.8;
      line-height: 1.5;
      white-space: pre-line;
      margin: 0;
    }

    .small { font-size: 13px; opacity: 0.5; margin-top: 24px; }

    a { color: #ffffff; text-decoration: underline; opacity: 0.85; }
    a:hover { opacity: 1; }

    .actions {
      margin-top: 28px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .btn {
      padding: 14px 18px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      border: 0;
      cursor: pointer;
      transition: transform 0.15s ease, opacity 0.15s ease;
    }

    .btn:hover { transform: translateY(-1px); opacity: 0.95; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-tiktok {
      background: linear-gradient(135deg, #25f4ee, #fe2c55);
      color: #0f0f0f;
      text-decoration: none;
    }

    .btn-generate {
      background: #1f1f1f;
      border: 1px solid #2a2a2a;
      color: #ffffff;
    }

    .result {
      margin-top: 6px;
      padding: 14px 16px;
      border-radius: 12px;
      background: #151515;
      border: 1px solid #2a2a2a;
      text-align: left;
      display: none;
    }

    .result strong {
      display: block;
      margin-bottom: 10px;
      font-size: 15px;
    }

    .cta {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #2a2a2a;
      opacity: 0.92;
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #1f1f1f;
      border: 1px solid #2a2a2a;
      font-weight: 700;
      letter-spacing: 0.2px;
      text-decoration: none;
    }

    .meta-row {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .share-btn {
      background: #1f1f1f;
      border: 1px solid #2a2a2a;
      color: #ffffff;
      padding: 8px 10px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }

    .share-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .error-box {
      margin-top: 6px;
      padding: 14px 16px;
      border-radius: 12px;
      background: rgba(254,44,85,0.08);
      border: 1px solid rgba(254,44,85,0.6);
      display: none;
      text-align: left;
    }
  </style>
</head>

<body>
<div class="box">
  <h1>AI –Ω–µ –ø–æ–Ω—è–ª</h1>

  <p>When AI tries its best.<br>Sometimes it doesn't.</p>
  <p style="margin-top:12px;">Personal experimental project.<br>No tracking.</p>

  <div class="actions">
    <a class="btn btn-tiktok" href="https://70ec38ff6d36.ngrok-free.app/auth/start">
      Sign in with TikTok
    </a>

    <button id="genBtn" class="btn btn-generate">Generate post</button>

    <div id="errorBox" class="error-box">
      <strong>ü§ñ AI –æ—Ç–≤–ª—ë–∫—Å—è</strong>
      <div id="errorText"></div>
    </div>

    <div id="result" class="result">
      <strong id="resultHeader"></strong>
      <p id="resultDescription"></p>

      <div class="cta">
        –ò—â–∏ –µ—ë –ø–æ–∑–∂–µ –≤ TikTok –ø–æ —Ö—ç—à—Ç–µ–≥—É<br>
        <a id="hashtagLink" class="pill" target="_blank">#‚Äî</a>

        <div class="meta-row">
          <button id="shareNativeBtn" class="share-btn" disabled>üì§ Share</button>
          <button id="copyImageBtn" class="share-btn" disabled>üìã Copy card</button>
          <button id="downloadPngBtn" class="share-btn" disabled>‚¨áÔ∏è PNG</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- html-to-image -->
<script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>

<script>
const API_BASE = "https://70ec38ff6d36.ngrok-free.app";

const SHARE_TEXTS = [
  (tag, url) => `AI –Ω–µ –ø–æ–Ω—è–ª, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–∑—è–ª—Å—è –∑–∞ —Ä–∞–±–æ—Ç—É üò§\n#aiNePonyal ${tag}\n${url}`,
  (tag, url) => `AI –ø–æ—Ç—è–Ω—É–ª—Å—è –∏ –ø–æ—à—ë–ª –¥—É–º–∞—Ç—å üß†\n#aiNePonyal ${tag}\n${url}`,
  (tag, url) => `AI –¥–µ–ª–∞–µ—Ç –≤–∏–¥, —á—Ç–æ –≤—Å—ë –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º üòé\n#aiNePonyal ${tag}\n${url}`,
  (tag, url) => `AI –≥–æ—Ç–æ–≤–∏—Ç —à—É—Ç–∫—É. –ù–µ –º–µ—à–∞–π—Ç–µ üòÖ\n#aiNePonyal ${tag}\n${url}`,
];

let lastResult = null;

const genBtn = document.getElementById("genBtn");
const result = document.getElementById("result");
const headerEl = document.getElementById("resultHeader");
const descEl = document.getElementById("resultDescription");
const hashtagLink = document.getElementById("hashtagLink");

const shareNativeBtn = document.getElementById("shareNativeBtn");
const copyImageBtn = document.getElementById("copyImageBtn");
const downloadPngBtn = document.getElementById("downloadPngBtn");

function tiktokSearchUrl(id) {
  return `https://www.tiktok.com/search?q=%23${encodeURIComponent(id)}`;
}

function buildShareText(id) {
  const pick = SHARE_TEXTS[Math.floor(Math.random()*SHARE_TEXTS.length)];
  return pick(`#${id}`, tiktokSearchUrl(id));
}

async function renderCard() {
  return await htmlToImage.toPng(result, {
    pixelRatio: 2,
    backgroundColor: "#151515"
  });
}

function dataUrlToFile(dataUrl) {
  const arr = dataUrl.split(",");
  const mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]);
  const u8 = new Uint8Array(bstr.length);
  for (let i=0;i<bstr.length;i++) u8[i]=bstr.charCodeAt(i);
  return new File([u8], "ai-ne-ponyal.png", {type:mime});
}

shareNativeBtn.onclick = async () => {
  const png = await renderCard();
  const file = dataUrlToFile(png);
  await navigator.share({
    title: "AI –Ω–µ –ø–æ–Ω—è–ª",
    text: buildShareText(lastResult.joke_id),
    files: [file]
  });
};

copyImageBtn.onclick = async () => {
  const png = await renderCard();
  const blob = await (await fetch(png)).blob();
  await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]);
};

downloadPngBtn.onclick = async () => {
  const png = await renderCard();
  const a = document.createElement("a");
  a.href = png;
  a.download = "ai-ne-ponyal.png";
  a.click();
};

genBtn.onclick = async () => {
  genBtn.disabled = true;
  const res = await fetch(`${API_BASE}/post/create`);
  const data = await res.json();

  lastResult = data;
  result.style.display = "block";

  headerEl.textContent = data.header;
  descEl.textContent = data.description;

  hashtagLink.textContent = `#${data.joke_id}`;
  hashtagLink.href = tiktokSearchUrl(data.joke_id);

  [shareNativeBtn, copyImageBtn, downloadPngBtn].forEach(b => b.disabled = false);
  genBtn.disabled = false;
};
</script>
</body>
</html>

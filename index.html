<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI ne ponyal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f0f0f;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    .box { max-width: 420px; padding: 24px; }
    h1 { font-size: 36px; margin-bottom: 12px; }

    p {
      font-size: 16px;
      opacity: 0.8;
      line-height: 1.5;
      white-space: pre-line; /* preserves \n from backend */
      margin: 0;
    }

    .small { font-size: 13px; opacity: 0.5; margin-top: 24px; }

    a { color: #ffffff; text-decoration: underline; opacity: 0.85; }
    a:hover { opacity: 1; }

    .actions {
      margin-top: 28px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .btn {
      display: inline-block;
      padding: 14px 18px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      text-decoration: none;
      border: 0;
      cursor: pointer;
      transition: transform 0.15s ease, opacity 0.15s ease;
      user-select: none;
    }
    .btn:hover { transform: translateY(-1px); opacity: 0.95; }
    .btn:active { transform: translateY(0); }
    .btn:disabled { cursor: not-allowed; opacity: 0.65; transform: none; }

    .btn-tiktok {
      background: linear-gradient(135deg, #25f4ee, #fe2c55);
      color: #0f0f0f;
      text-decoration: none;
    }

    .btn-generate {
      background: #1f1f1f;
      border: 1px solid #2a2a2a;
      color: #ffffff;
    }

    /* Shareable result card */
    .result {
      margin-top: 6px;
      padding: 14px 16px;
      border-radius: 12px;
      background: #151515;
      border: 1px solid #2a2a2a;
      text-align: left;
      display: none;
    }

    .result strong {
      display: block;
      margin-bottom: 10px;
      font-size: 15px;
    }

    .cta {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #2a2a2a;
      opacity: 0.92;
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #1f1f1f;
      border: 1px solid #2a2a2a;
      font-weight: 700;
      letter-spacing: 0.2px;
      text-decoration: none;
    }

    .meta-row {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .open-link {
      text-decoration: none;
      opacity: 0.9;
      font-weight: 600;
      color: #69c9d0;
    }
    .open-link:hover { opacity: 1; text-decoration: underline; }

    .share-btn {
      background: #1f1f1f;
      border: 1px solid #2a2a2a;
      color: #ffffff;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s ease, opacity 0.15s ease;
      white-space: nowrap;
    }
    .share-btn:hover { transform: translateY(-1px); opacity: 0.95; }
    .share-btn:active { transform: translateY(0); }
    .share-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .error-box {
      margin-top: 6px;
      padding: 14px 16px;
      border-radius: 12px;
      background: rgba(254, 44, 85, 0.08);
      border: 1px solid rgba(254, 44, 85, 0.6);
      text-align: left;
      display: none;
    }
    .error-box strong { display: block; margin-bottom: 6px; font-size: 14px; }

    .tiktok {
      margin-top: 28px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      font-size: 15px;
      color: #ffffff;
      opacity: 0.9;
    }
    .tiktok svg { width: 20px; height: 20px; fill: white; opacity: 0.9; }
    .tiktok:hover { opacity: 1; text-decoration: underline; }
  </style>
</head>

<body>
  <div class="box">
    <h1>AI –Ω–µ –ø–æ–Ω—è–ª</h1>

    <p>When AI tries its best.<br />Sometimes it doesn't.</p>
    <p style="margin-top:12px;">Personal experimental project.<br />No data collection. No tracking.</p>

    <div class="actions">
      <a class="btn btn-tiktok" href="https://70ec38ff6d36.ngrok-free.app/auth/start">
        Sign in with TikTok
      </a>

      <button id="genBtn" class="btn btn-generate" type="button">
        Generate post
      </button>

      <div id="errorBox" class="error-box" aria-live="polite">
        <strong id="errorTitle">‚ö†Ô∏è Error</strong>
        <div id="errorText">Something went wrong.</div>
      </div>

      <!-- Shareable card -->
      <div id="result" class="result" aria-live="polite">
        <strong id="resultHeader">üß† AI –≥–æ—Ç–æ–≤–∏—Ç —á—Ç–æ-—Ç–æ —Å–º–µ—à–Ω–æ–µ</strong>
        <p id="resultDescription"></p>

        <div class="cta">
          <div style="font-weight:700; font-size:18px; opacity:0.95;">
            –ò—â–∏ –µ—ë –ø–æ–∑–∂–µ –≤ TikTok –ø–æ —Ö—ç—à—Ç–µ–≥—É
          </div>

          <div style="margin-top:10px;">
            <a id="hashtagLink" class="pill" href="#" target="_blank" rel="noopener noreferrer">#‚Äî</a>
          </div>

          <div style="margin-top:12px; opacity:0.92;">
            –ò–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞:
            <a class="open-link" href="https://www.tiktok.com/@ai_ne_ponyal" target="_blank" rel="noopener noreferrer">
              @ai_ne_ponyal
            </a>
          </div>

          <div class="meta-row">
            <a id="tiktokSearchLink" class="open-link" href="#" target="_blank" rel="noopener noreferrer">
              üîç –û—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫ TikTok
            </a>

            <!-- Buttons will be shown/hidden depending on browser capabilities -->
            <button id="shareNativeBtn" class="share-btn" type="button" disabled style="display:none;">
              üì§ Share
            </button>

            <button id="copyImageBtn" class="share-btn" type="button" disabled style="display:none;">
              üìã Copy card
            </button>

            <button id="downloadPngBtn" class="share-btn" type="button" disabled style="display:none;">
              ‚¨áÔ∏è Download PNG
            </button>
          </div>

          <div id="shareHint" style="margin-top:10px; font-size:13px; opacity:0.6; display:none;">
            Tip: for Telegram, ‚ÄúCopy card‚Äù ‚Üí paste into chat works best.
          </div>
        </div>
      </div>
    </div>

    <a class="tiktok" href="https://www.tiktok.com/@ai_ne_ponyal" target="_blank" rel="noopener noreferrer">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M21 8.3c-1.5 0-3-.5-4.2-1.4v7.2a6.1 6.1 0 1 1-6.1-6.1c.3 0 .6 0 .9.1v3.1a2.9 2.9 0 1 0 2 2.8V2h3.2c.3 2.1 2 3.8 4.2 4.1v2.2z"/>
      </svg>
      Follow on TikTok @ai_ne_ponyal
    </a>

    <div class="small">
      <a href="./privacy.html">Privacy Policy</a> ¬∑
      <a href="./terms.html">Terms of Service</a>
    </div>
  </div>

  <!-- Load html-to-image (two CDNs, then dynamic fallback in JS) -->
  <script defer src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>

  <script>
    const API_BASE = "https://70ec38ff6d36.ngrok-free.app";

    const btn = document.getElementById("genBtn");

    const errorBox = document.getElementById("errorBox");
    const errorTitle = document.getElementById("errorTitle");
    const errorText = document.getElementById("errorText");

    const resultCard = document.getElementById("result");
    const resultHeader = document.getElementById("resultHeader");
    const resultDescription = document.getElementById("resultDescription");

    const hashtagLink = document.getElementById("hashtagLink");
    const tiktokSearchLink = document.getElementById("tiktokSearchLink");

    const shareNativeBtn = document.getElementById("shareNativeBtn");
    const copyImageBtn = document.getElementById("copyImageBtn");
    const downloadPngBtn = document.getElementById("downloadPngBtn");
    const shareHint = document.getElementById("shareHint");

    let lastResult = null;

    function showError(title, text) {
      resultCard.style.display = "none";
      errorBox.style.display = "block";
      errorTitle.textContent = title;
      errorText.textContent = text;
      disableShareButtons();
    }

    function hideError() {
      errorBox.style.display = "none";
    }

    function disableShareButtons() {
      [shareNativeBtn, copyImageBtn, downloadPngBtn].forEach(b => b.disabled = true);
    }

    function setShareButtonsEnabled(enabled) {
      [shareNativeBtn, copyImageBtn, downloadPngBtn].forEach(b => {
        if (b.style.display !== "none") b.disabled = !enabled;
      });
    }

    function tiktokSearchUrlByHashtag(tagWithoutHash) {
      return `https://www.tiktok.com/search?q=%23${encodeURIComponent(tagWithoutHash)}`;
    }

    function detectShareCapabilities() {
      const canNativeShare = !!(navigator.share && navigator.canShare);
      const canCopyImage = !!(navigator.clipboard && window.ClipboardItem);
      const canDownload = true;

      // Show the best options for each environment
      // Native share with files is tricky: we will enable only if canShare(files) is true AFTER we create a file.
      // For now, we keep it visible if navigator.share exists.
      shareNativeBtn.style.display = canNativeShare ? "" : "none";
      copyImageBtn.style.display = canCopyImage ? "" : "none";
      downloadPngBtn.style.display = canDownload ? "" : "none";

      // Telegram UX tip
      shareHint.style.display = (copyImageBtn.style.display !== "none") ? "" : "none";
    }

    detectShareCapabilities();

    function showResult(data) {
      hideError();
      resultCard.style.display = "block";

      const id = String(data.joke_id);
      const hashtag = `#${id}`;
      const searchUrl = tiktokSearchUrlByHashtag(id);

      resultHeader.textContent = data.header || "üß† AI –≥–æ—Ç–æ–≤–∏—Ç —á—Ç–æ-—Ç–æ —Å–º–µ—à–Ω–æ–µ";
      resultDescription.textContent = data.description || "–ù—É–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. AI —É–∂–µ –≥–æ—Ç–æ–≤–∏—Ç—Å—è –¥—É–º–∞—Ç—å.";

      hashtagLink.textContent = hashtag;
      hashtagLink.href = searchUrl;
      tiktokSearchLink.href = searchUrl;

      lastResult = { ...data, _searchUrl: searchUrl };

      // enable visible share buttons
      setShareButtonsEnabled(true);
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    async function ensureHtmlToImageLoaded() {
      if (window.htmlToImage && typeof window.htmlToImage.toPng === "function") return;

      const candidates = [
        "https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.min.js",
        "https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js",
      ];

      for (const url of candidates) {
        try {
          await loadScript(url);
          if (window.htmlToImage && typeof window.htmlToImage.toPng === "function") return;
        } catch {}
      }

      throw new Error("html-to-image not available");
    }

    async function renderCardToPngDataUrl() {
      await ensureHtmlToImageLoaded();

      // Render ONLY the card (#result) to PNG
      return await window.htmlToImage.toPng(resultCard, {
        pixelRatio: 2,
        cacheBust: true,
        backgroundColor: "#151515",
      });
    }

    function dataUrlToFile(dataUrl, filename) {
      const arr = dataUrl.split(",");
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) u8arr[n] = bstr.charCodeAt(n);
      return new File([u8arr], filename, { type: mime });
    }

    async function copyCardImageToClipboard(dataUrl) {
      const blob = await (await fetch(dataUrl)).blob();
      await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
    }

    function downloadDataUrl(dataUrl, filename) {
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function setButtonBusy(btnEl, busyText) {
      const old = btnEl.textContent;
      btnEl.disabled = true;
      btnEl.textContent = busyText;
      return () => {
        btnEl.textContent = old;
        // enabled back only if result is visible
        btnEl.disabled = (resultCard.style.display === "none");
      };
    }

    async function nativeSharePngFile(file, jokeId) {
      // IMPORTANT:
      // Even if navigator.share works, some targets (Telegram) may ignore files.
      // We still try, but we only claim success if share() resolves.
      let title = "AI –Ω–µ –ø–æ–Ω—è–ª";
      if (jokeId) {
        const url = `https://www.tiktok.com/search?q=%23aineponyal%20%23${encodeURIComponent(jokeId)}`;
        title = `AI –Ω–µ –ø–æ–Ω—è–ª, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–∑—è–ª—Å—è –∑–∞ —Ä–∞–±–æ—Ç—É üò§\n#aiNePonyal #${jokeId}\n${url}`;
      }
      await navigator.share({
        title: title,
        text: " ", // avoid title-only shares
        files: [file],
      });
    }

    shareNativeBtn.addEventListener("click", async () => {
      if (!lastResult) return;

      const restore = setButtonBusy(shareNativeBtn, "Sharing‚Ä¶");
      try {
        const dataUrl = await renderCardToPngDataUrl();
        const file = dataUrlToFile(dataUrl, "ai-ne-ponyal.png");

        // If browser says it can't share files, fallback immediately
        if (!navigator.canShare || !navigator.canShare({ files: [file] })) {
          // Fallback to copy if possible, else download
          if (copyImageBtn.style.display !== "none") {
            await copyCardImageToClipboard(dataUrl);
            shareNativeBtn.textContent = "‚úÖ Copied";
          } else {
            downloadDataUrl(dataUrl, "ai-ne-ponyal.png");
            shareNativeBtn.textContent = "‚¨áÔ∏è Downloaded";
          }
          setTimeout(restore, 1000);
          return;
        }

        await nativeSharePngFile(file, lastResult.joke_id);
        shareNativeBtn.textContent = "‚úÖ Shared";
        setTimeout(restore, 1000);
      } catch (e) {
        console.error(e);
        restore();
        showError("ü§ñ AI –æ—Ç–≤–ª—ë–∫—Å—è", "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–∞—Ä—Ç–æ—á–∫–æ–π. –ü–æ–ø—Ä–æ–±—É–π ‚ÄúCopy card‚Äù –∏–ª–∏ ‚ÄúDownload PNG‚Äù.");
      }
    });

    copyImageBtn.addEventListener("click", async () => {
      if (!lastResult) return;

      const restore = setButtonBusy(copyImageBtn, "Copying‚Ä¶");
      try {
        const dataUrl = await renderCardToPngDataUrl();
        await copyCardImageToClipboard(dataUrl);
        copyImageBtn.textContent = "‚úÖ Copied";
        setTimeout(restore, 1000);
      } catch (e) {
        console.error(e);
        restore();
        showError("ü§ñ AI –æ—Ç–≤–ª—ë–∫—Å—è", "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É. –ü–æ–ø—Ä–æ–±—É–π ‚ÄúDownload PNG‚Äù.");
      }
    });

    downloadPngBtn.addEventListener("click", async () => {
      if (!lastResult) return;

      const restore = setButtonBusy(downloadPngBtn, "Preparing‚Ä¶");
      try {
        const dataUrl = await renderCardToPngDataUrl();
        downloadDataUrl(dataUrl, "ai-ne-ponyal.png");
        downloadPngBtn.textContent = "‚¨áÔ∏è Downloaded";
        setTimeout(restore, 1000);
      } catch (e) {
        console.error(e);
        restore();
        showError("ü§ñ AI –æ—Ç–≤–ª—ë–∫—Å—è", "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å PNG. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
      }
    });

    btn.addEventListener("click", async () => {
      btn.disabled = true;
      btn.textContent = "AI is thinking‚Ä¶";
      disableShareButtons();

      try {
        const res = await fetch(`${API_BASE}/post/create`, {
          method: "GET",
          headers: {
            "Accept": "application/json",
            "ngrok-skip-browser-warning": "true"
          },
        });

        if (!res.ok) {
          showError("ü§ñ AI –Ω—É–∂–Ω–æ –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏", "–°–µ–π—á–∞—Å –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –Ω–∞—á–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
          return;
        }

        let data;
        try {
          data = await res.json();
        } catch {
          showError("ü§ñ AI –∑–∞–¥—É–º–∞–ª—Å—è —Å–ª–∏—à–∫–æ–º –≥–ª—É–±–æ–∫–æ", "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
          return;
        }

        if (!data || !data.joke_id) {
          showError("ü§ñ AI –∑–∞–±—ã–ª –Ω–æ–º–µ—Ä —à—É—Ç–∫–∏", "–í –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ—Ç joke_id.");
          return;
        }

        showResult(data);
      } catch (e) {
        console.error(e);
        showError("ü§ñ AI –Ω–µ –¥–æ–±—Ä–∞–ª—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
      } finally {
        btn.disabled = false;
        btn.textContent = "Generate post";
      }
    });
  </script>
</body>
</html>
